# | This workflow can be invoked only from root workflow.
# | More information about Reusing workflows - https://docs.github.com/en/actions/using-workflows/reusing-workflows

name: "Reusable :: Generate unit tests codecov report"

on:
  workflow_call:
    inputs:
      base-branch-codecov-artifact-name:
        required: true
        type: string
      working-branch-codecov-artifact-name:
        required: true
        type: string

    # https://docs.github.com/en/actions/using-workflows/reusing-workflows#using-outputs-from-a-reusable-workflow:
    outputs:
      codecov_unit_percentage:
        description: "Total Percentage coverage"
        value: ${{ jobs.generate_report.outputs.codecov_output_percentage }}
      codecov_unit_diff:
        description: "Percentage difference between head branch, if PR is available for current workflow run"
        value: ${{ jobs.generate_report.outputs.codecov_output_diff }}
    secrets:
      barecheck_github_app_token:
        required: true

jobs:
  generate_report:
    name: "Generate"
    runs-on: ubuntu-latest
    outputs:
      codecov_output_percentage: ${{ steps.code-coverage.outputs.percentage }}
      codecov_output_diff: ${{ steps.code-coverage.outputs.diff }}
    steps:
      - name: "Download code coverage report from base branch"
        uses: actions/download-artifact@v2
        id: download-base
        with:
          name: ${{inputs.base-branch-codecov-artifact-name}}
          path: ./base-report

      - name: "Download code coverage report from working branch"
        uses: actions/download-artifact@v2
        id: download-working
        with:
          name: ${{inputs.working-branch-codecov-artifact-name}}
          path: ./working-report

      - name: "Generate code coverage report"
        id: code-coverage
        continue-on-error: true
        uses: barecheck/code-coverage-action@v0.5.1
        with:
          barecheck-github-app-token: ${{ secrets.barecheck_github_app_token }}
          lcov-file: './working-report/lcov.info'
          base-lcov-file: './base-report/lcov.info'
          send-summary-comment: "false"
          show-annotations: 'warning'
